<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.2rem; }
        .day-box { min-height: 80px; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-gray-800 text-gray-100 min-h-screen">

    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <h2 class="text-2xl mb-4">Acesso Administrativo</h2>
            <button onclick="checkAuth()" class="bg-blue-600 px-6 py-2 rounded">Entrar</button>
        </div>
    </div>

    <nav class="bg-gray-900 p-4 shadow flex justify-between items-center">
        <h1 class="font-bold text-xl">Painel Admin</h1>
        <button onclick="logout()" class="text-red-400 text-sm">Sair</button>
    </nav>

    <main class="p-4 max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-4">
            <button id="prev" class="bg-gray-700 px-3 py-1 rounded"><</button>
            <h2 id="monthTitle" class="text-xl font-bold"></h2>
            <button id="next" class="bg-gray-700 px-3 py-1 rounded">></button>
        </div>

        <div class="grid grid-cols-7 text-center font-bold mb-2">
            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
        </div>
        <div id="adminGrid" class="calendar-grid"></div>
    </main>

<script>
        // --- CONFIGURAÇÃO ---
        const SUPABASE_URL = 'https://qgsvnaltmidtzjxeyylu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_vAGlHnc6wjdSfXhi-BzAZA_x2jRT5uh';
        
        // CORREÇÃO 1: Criando a conexão com o nome _supabase
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // SENHA SIMPLES
        const ADMIN_PASS = "123456"; 

        let currentDate = new Date();
        let reservas = [];
        let calendarioCustom = [];

        function checkAuth() {
            Swal.fire({
                title: 'Senha Admin',
                input: 'password',
                confirmButtonText: 'Acessar',
                showCancelButton: false
            }).then((result) => {
                if (result.value === ADMIN_PASS) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    loadData();
                } else {
                    Swal.fire('Senha incorreta', '', 'error');
                }
            });
        }

        function logout() { location.reload(); }

        document.getElementById('prev').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); loadData(); };
        document.getElementById('next').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); loadData(); };

        async function loadData() {
            // CORREÇÃO 2: Usando _supabase aqui
            const { data: r } = await _supabase.from('reservas').select('*');
            reservas = r || [];
            
            // CORREÇÃO 3: Usando _supabase aqui
            const { data: c } = await _supabase.from('calendario_custom').select('*');
            calendarioCustom = c || [];
            
            renderAdmin();
        }

        function renderAdmin() {
            const grid = document.getElementById('adminGrid');
            const monthTitle = document.getElementById('monthTitle');
            grid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthTitle.innerText = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let day=1; day<=daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const el = document.createElement('div');
                el.className = 'day-box bg-gray-700 rounded p-1 hover:bg-gray-600 cursor-pointer relative border border-gray-600';
                
                let html = `<div class="font-bold text-right">${day}</div>`;

                const reserva = reservas.find(r => r.data === dateStr);
                const custom = calendarioCustom.find(c => c.data === dateStr);

                if (custom?.tipo === 'bloqueio') {
                    el.classList.add('bg-red-900');
                    html += `<div class="text-xs text-red-300 mt-1"><i class="fa fa-lock"></i> Bloqueado</div>`;
                } else if (custom?.tipo === 'preco_especial') {
                    html += `<div class="text-xs text-green-300 mt-1">R$ ${custom.novo_valor}</div>`;
                }

                if (reserva) {
                    const color = reserva.status === 'pendente' ? 'text-yellow-400' : 'text-green-400';
                    const icon = reserva.status === 'pendente' ? 'fa-clock' : 'fa-check';
                    html += `<div class="text-xs ${color} mt-1 border-t border-gray-500 pt-1">
                                <i class="fa ${icon}"></i> ${reserva.nome.split(' ')[0]}
                             </div>`;
                }

                el.innerHTML = html;
                el.onclick = () => gerenciarData(dateStr, reserva, custom);
                grid.appendChild(el);
            }
        }

        async function gerenciarData(dateStr, reserva, custom) {
            const acoes = {};
            if (reserva) acoes.reserva = true;
            
            await Swal.fire({
                title: `Gestão: ${dateStr}`,
                html: `
                    ${reserva ? `
                        <div class="bg-gray-100 p-2 rounded text-gray-800 mb-2 text-left text-sm">
                            <p><strong>Cliente:</strong> ${reserva.nome}</p>
                            <p><strong>Tel:</strong> ${reserva.telefone}</p>
                            <p><strong>Status:</strong> ${reserva.status.toUpperCase()}</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="window.atualizarReserva('${dateStr}', 'confirmado')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Aprovar</button>
                                <button onclick="window.deletarReserva('${dateStr}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Excluir</button>
                            </div>
                        </div>
                    ` : ''}
                    <hr class="my-3">
                    <h3 class="text-sm font-bold mb-2">Configurações da Data</h3>
                    <div class="flex flex-col gap-2">
                        <button onclick="window.setPreco('${dateStr}')" class="bg-blue-500 text-white py-2 rounded">Definir Preço Especial</button>
                        <button onclick="window.setBloqueio('${dateStr}')" class="bg-gray-600 text-white py-2 rounded">Bloquear Data (Não Alugar)</button>
                        <button onclick="window.limparData('${dateStr}')" class="bg-white text-gray-800 border py-2 rounded">Limpar Configurações</button>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        // --- FUNÇÕES GLOBAIS (Também precisam usar _supabase) ---

        window.setPreco = async (date) => {
            const { value: preco } = await Swal.fire({title: 'Novo Valor', input: 'number'});
            if(preco) {
                // CORREÇÃO 4
                await _supabase.from('calendario_custom').upsert({ data: date, tipo: 'preco_especial', novo_valor: preco });
                Swal.close(); loadData();
            }
        };

        window.setBloqueio = async (date) => {
            // CORREÇÃO 5
            await _supabase.from('calendario_custom').upsert({ data: date, tipo: 'bloqueio', novo_valor: null });
            Swal.close(); loadData();
        };

        window.limparData = async (date) => {
            // CORREÇÃO 6
            await _supabase.from('calendario_custom').delete().eq('data', date);
            Swal.close(); loadData();
        };

        window.atualizarReserva = async (date, status) => {
            // CORREÇÃO 7
            await _supabase.from('reservas').update({ status }).eq('data', date);
            Swal.close(); loadData();
        };

        window.deletarReserva = async (date) => {
            // CORREÇÃO 8
            await _supabase.from('reservas').delete().eq('data', date);
            Swal.close(); loadData();
        };
    </script>
</body>
</html>