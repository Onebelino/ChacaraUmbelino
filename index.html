<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chácara Umbelino - Reservas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .swiper-button-next, .swiper-button-prev { color: #fff; text-shadow: 0 0 4px rgba(0,0,0,0.6); }
        .day-card { aspect-ratio: 1/1; }
        
        @media (max-width: 600px) { 
            .calendar-grid { gap: 0.2rem; } 
            .day-card { font-size: 0.8rem; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <nav class="glass-nav fixed w-full z-50 shadow-md top-0">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-xl md:text-2xl font-bold text-green-800 tracking-tight">
                <i class="fa-solid fa-tree"></i> Chácara Umbelino
            </a>
            
            <div class="hidden md:flex space-x-8 font-medium text-gray-600">
                <a href="#somos" class="hover:text-green-700 transition">A Chácara</a>
                <a href="#fotos" class="hover:text-green-700 transition">Fotos</a>
                <a href="#regras" class="hover:text-green-700 transition">Regras</a>
                <a href="#agenda" class="px-5 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition shadow hover:shadow-lg">Reservar Agora</a>
            </div>

            <a href="#agenda" class="md:hidden text-green-700 text-2xl"><i class="fa-solid fa-calendar-check"></i></a>
        </div>
    </nav>

    <section class="relative h-[65vh] flex items-center justify-center bg-gray-900 mt-16 overflow-hidden">
        <img id="heroImage" src="" class="absolute inset-0 w-full h-full object-cover opacity-60 transition duration-700" alt="Capa">
        
        <div class="relative z-10 text-center text-white px-4 max-w-4xl">
            <h1 class="text-4xl md:text-6xl font-bold mb-6 drop-shadow-lg">Momentos Inesquecíveis</h1>
            <p class="text-lg md:text-2xl mb-8 drop-shadow-md font-light">Lazer, segurança e conforto para sua família.</p>
            <a href="#agenda" class="inline-block bg-green-500 text-white px-8 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-green-600 hover:-translate-y-1 transition transform">
                Ver Datas Disponíveis
            </a>
        </div>
    </section>

    <section id="somos" class="py-16 max-w-5xl mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Sobre o Espaço</h2>
        <p id="texto-sobre" class="text-gray-600 text-lg leading-relaxed mb-10 max-w-3xl mx-auto">
            Carregando informações...
        </p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-4 bg-white shadow rounded-lg border-b-4 border-blue-500">
                <i class="fa-solid fa-water text-3xl text-blue-500 mb-2"></i><h3 class="font-bold">Piscina</h3>
            </div>
            <div class="p-4 bg-white shadow rounded-lg border-b-4 border-orange-500">
                <i class="fa-solid fa-fire-burner text-3xl text-orange-500 mb-2"></i><h3 class="font-bold">Churrasqueira</h3>
            </div>
            <div class="p-4 bg-white shadow rounded-lg border-b-4 border-green-500">
                <i class="fa-solid fa-tree text-3xl text-green-500 mb-2"></i><h3 class="font-bold">Natureza</h3>
            </div>
            <div class="p-4 bg-white shadow rounded-lg border-b-4 border-gray-500">
                <i class="fa-solid fa-wifi text-3xl text-gray-500 mb-2"></i><h3 class="font-bold">Wi-Fi</h3>
            </div>
        </div>
    </section>

    <section id="fotos" class="py-16 bg-gray-900">
        <div class="max-w-6xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Nossa Galeria</h2>
            
            <div class="swiper mySwiper w-full h-[300px] md:h-[500px] rounded-2xl shadow-2xl bg-black">
                <div class="swiper-wrapper" id="swiper-wrapper">
                    </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
    </section>

    <section id="agenda" class="py-16 bg-green-50">
        <div class="max-w-4xl mx-auto px-4">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-green-900">Calendário de Reservas</h2>
                <p class="text-gray-600 mt-2">Clique em uma data <span class="text-green-600 font-bold">LIVRE</span> para ver o preço.</p>
            </div>

            <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl border border-green-100">
                <div class="flex justify-between items-center mb-6">
                    <button id="prevMonth" class="px-4 py-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="currentMonthYear" class="text-xl md:text-2xl font-bold capitalize text-gray-700"></h2>
                    <button id="nextMonth" class="px-4 py-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-gray-400 text-xs md:text-sm tracking-widest">
                    <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SÁB</div>
                </div>

                <div id="calendarGrid" class="calendar-grid"></div>

                <div class="flex justify-center gap-6 mt-6 text-sm text-gray-600">
                    <span class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div> Livre</span>
                    <span class="flex items-center"><div class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></div> Pendente</span>
                    <span class="flex items-center"><div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div> Ocupado</span>
                </div>
            </div>
        </div>
    </section>

    <section id="regras" class="py-16 max-w-4xl mx-auto px-4">
        <div class="bg-red-50 border-l-8 border-red-500 p-8 rounded shadow-sm">
            <h2 class="text-2xl font-bold text-red-800 mb-4"><i class="fa-solid fa-triangle-exclamation"></i> Regras Importantes</h2>
            <div id="texto-regras" class="text-gray-800 whitespace-pre-line text-lg leading-relaxed">
                Carregando regras...
            </div>
        </div>
    </section>

    <footer class="bg-gray-900 text-gray-400 py-10 text-center border-t border-gray-800">
        <p class="font-bold text-white mb-2">Chácara Umbelino</p>
        <p class="text-sm">&copy; 2026 Todos os direitos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <script>
        // ============================================
        // 1. CONFIGURAÇÃO (COLE SUAS CHAVES AQUI)
        // ============================================
        const SUPABASE_URL = 'https://qgsvnaltmidtzjxeyylu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_vAGlHnc6wjdSfXhi-BzAZA_x2jRT5uh';
        
        // Conexão Segura
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Variáveis de Estado
        let currentDate = new Date();
        let configGlobal = {};
        let reservas = [];
        let calendarioCustom = [];

        // ============================================
        // 2. INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchConfig();
            await fetchGaleria();
            await fetchDadosMes();
            renderCalendar();
        });

        document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
        document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

        // ============================================
        // 3. BUSCA DE DADOS (SUPABASE)
        // ============================================
        async function fetchConfig() {
            const { data } = await _supabase.from('config').select('*').single();
            if(data) {
                configGlobal = data;
                // Preenche textos na tela
                document.getElementById('texto-sobre').innerText = data.texto_sobre || "Bem vindo.";
                document.getElementById('texto-regras').innerText = data.texto_regras || "Regras de uso em breve.";
                
                // Preenche Capa
                const heroImg = document.getElementById('heroImage');
                heroImg.src = data.url_capa ? data.url_capa : "https://images.unsplash.com/photo-1576013551627-0cc20b96c2a7?q=80&w=2070";
            }
        }

        async function fetchGaleria() {
            const { data } = await _supabase.from('galeria').select('*').order('id', {ascending: false});
            const wrapper = document.getElementById('swiper-wrapper');
            wrapper.innerHTML = '';
            
            if(data && data.length > 0) {
                data.forEach(foto => {
                    wrapper.innerHTML += `
                        <div class="swiper-slide">
                            <img src="${foto.url_imagem}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition" />
                        </div>`;
                });
                
                // Inicia Carrossel
                new Swiper(".mySwiper", {
                    loop: true,
                    pagination: { el: ".swiper-pagination", clickable: true },
                    navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
                    autoplay: { delay: 4000, disableOnInteraction: false },
                });
            }
        }

        async function fetchDadosMes() {
            const { data: res } = await _supabase.from('reservas').select('*');
            reservas = res || [];
            const { data: custom } = await _supabase.from('calendario_custom').select('*');
            calendarioCustom = custom || [];
        }

        // ============================================
        // 4. LÓGICA DO CALENDÁRIO
        // ============================================
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('currentMonthYear');
            
            grid.innerHTML = '';
            monthYear.innerText = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const hoje = new Date(); 
            hoje.setHours(0,0,0,0); // Zera hora para comparar apenas datas

            // Dias vazios do começo do mês
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Loop dos dias
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const el = document.createElement('div');
                el.className = 'day-card flex flex-col items-center justify-between p-1 rounded-xl shadow-sm text-sm relative transition border border-gray-100 overflow-hidden';
                
                const dayNumber = `<span class="text-xs font-bold self-start pl-1 text-gray-400">${day}</span>`;

                // 1. Dias Passados
                if (dateObj < hoje) {
                    el.classList.add('bg-gray-100', 'cursor-not-allowed');
                    el.innerHTML = dayNumber;
                } else {
                    // 2. Dias Futuros
                    const reserva = reservas.find(r => r.data === dateStr);
                    const custom = calendarioCustom.find(c => c.data === dateStr);
                    
                    let status = 'livre'; 
                    let valor = custom?.tipo === 'preco_especial' ? custom.novo_valor : configGlobal.preco_padrao;

                    if (custom?.tipo === 'bloqueio') status = 'ocupado';
                    else if (reserva?.status === 'confirmado') status = 'ocupado';
                    else if (reserva?.status === 'pendente') status = 'pendente';

                    // Renderização baseada no Status
                    if (status === 'ocupado') {
                        el.classList.add('bg-red-500', 'text-white', 'opacity-90', 'cursor-not-allowed');
                        el.innerHTML = `${dayNumber}<div class="flex-1 flex items-center justify-center"><i class="fa fa-lock"></i></div>`;
                    } else if (status === 'pendente') {
                        el.classList.add('bg-yellow-400', 'text-white', 'cursor-not-allowed');
                        el.innerHTML = `${dayNumber}<span class="text-[10px] mb-1 font-medium">Pendente</span>`;
                    } else {
                        // DIA LIVRE
                        el.classList.add('bg-white', 'text-gray-700', 'hover:bg-green-600', 'hover:text-white', 'hover:shadow-xl', 'cursor-pointer', 'group');
                        el.onclick = () => abrirReserva(dateStr, valor);
                        
                        el.innerHTML = `
                            ${dayNumber}
                            <div class="flex flex-col items-center justify-center pb-1 w-full">
                                <span class="text-[9px] text-green-600 group-hover:text-green-200 uppercase font-bold">A partir</span>
                                <span class="text-sm font-extrabold text-green-700 group-hover:text-white">R$ ${valor}</span>
                            </div>
                        `;
                    }
                }
                grid.appendChild(el);
            }
        }

        // ============================================
        // 5. UTILITÁRIOS (MÁSCARA E VALIDAÇÃO CPF)
        // ============================================
        function mascaraCPF(i) {
            let v = i.value;
            if(isNaN(v[v.length-1])){ i.value = v.substring(0, v.length-1); return; }
            i.setAttribute("maxlength", "14");
            if (v.length == 3 || v.length == 7) i.value += ".";
            if (v.length == 11) i.value += "-";
        }

        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf == '') return false;
            if (cpf.length != 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let add = 0;
            for (let i=0; i < 9; i ++) add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(9))) return false;
            
            add = 0;
            for (let i = 0; i < 10; i ++) add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(10))) return false;
            return true;
        }

        // ============================================
        // 6. FORMULÁRIO DE RESERVA
        // ============================================
        async function abrirReserva(dataISO, valor) {
            const dataFormatada = new Date(dataISO + 'T00:00:00').toLocaleDateString('pt-BR');
            const regrasTexto = configGlobal.texto_regras;

            const { value: formValues } = await Swal.fire({
                title: `<span class="text-2xl font-bold text-green-700">Reservar: ${dataFormatada}</span>`,
                html: `
                    <div class="text-left mb-4 bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-2xl font-bold text-green-800 text-center">R$ ${valor}</p>
                        <p class="text-xs text-center text-gray-500 mt-1">Ao reservar, você aceita as regras do local.</p>
                    </div>
                    <div class="space-y-3">
                        <input id="swal-nome" class="swal2-input m-0 w-full" placeholder="Nome Completo">
                        <input id="swal-cpf" class="swal2-input m-0 w-full" placeholder="CPF (000.000.000-00)" oninput="mascaraCPF(this)">
                        <input id="swal-end" class="swal2-input m-0 w-full" placeholder="Endereço (Rua, Nº, Bairro)">
                        <input id="swal-tel" class="swal2-input m-0 w-full" placeholder="WhatsApp (DDD + Número)">
                    </div>
                `,
                focusConfirm: false,
                confirmButtonColor: '#16a34a',
                confirmButtonText: 'Confirmar e Gerar Contrato <i class="fa fa-file-pdf"></i>',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nome = document.getElementById('swal-nome').value;
                    const cpf = document.getElementById('swal-cpf').value;
                    const end = document.getElementById('swal-end').value;
                    const tel = document.getElementById('swal-tel').value;

                    if (!nome || !cpf || !end || !tel) {
                        Swal.showValidationMessage('Por favor, preencha todos os campos!');
                        return false;
                    }
                    if (!validarCPF(cpf)) {
                        Swal.showValidationMessage('CPF inválido! Verifique os números.');
                        return false;
                    }

                    return { nome, cpf, end, tel, valor, dataISO, dataFormatada, regrasTexto };
                }
            });

            if (formValues) processarReserva(formValues);
        }

        async function processarReserva(dados) {
            Swal.fire({ title: 'Processando...', didOpen: () => Swal.showLoading() });

            const { error } = await _supabase.from('reservas').insert({
                data: dados.dataISO,
                status: 'pendente',
                nome: dados.nome,
                cpf: dados.cpf,
                endereco: dados.end,
                telefone: dados.tel,
                valor_final: dados.valor
            });

            if (error) {
                Swal.fire('Ops!', 'Parece que alguém acabou de reservar esta data.', 'error');
                return;
            }

            gerarPDF(dados);

            const msg = `Olá! Gostaria de confirmar minha reserva na Chácara Umbelino.%0ADia: *${dados.dataFormatada}*.%0AValor: R$ ${dados.valor}.%0ANome: ${dados.nome}.%0A%0A*Estou enviando o contrato assinado em anexo.*`;
            
            Swal.fire({
                icon: 'success',
                title: 'Reserva Realizada!',
                html: 'O contrato foi baixado no seu celular/PC.<br><b>Envie-o agora no WhatsApp para validar.</b>',
                confirmButtonText: '<i class="fab fa-whatsapp"></i> Enviar no WhatsApp',
                confirmButtonColor: '#25D366'
            }).then(() => {
                window.open(`https://wa.me/5544997089269?text=${msg}`, '_blank');
                location.reload(); 
            });
        }

        function gerarPDF(dados) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Design do Contrato
            doc.setFillColor(22, 163, 74); // Verde Topo
            doc.rect(0, 0, 210, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("CONTRATO DE LOCAÇÃO - CHÁCARA UMBELINO", 105, 16, null, null, "center");

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            
            let y = 40;
            doc.text(`LOCATÁRIO: ${dados.nome.toUpperCase()}`, 20, y); y+=8;
            doc.text(`CPF: ${dados.cpf}   |   WHATSAPP: ${dados.tel}`, 20, y); y+=8;
            doc.text(`ENDEREÇO: ${dados.end}`, 20, y); y+=15;

            // Box de Detalhes
            doc.setFillColor(245, 245, 245);
            doc.rect(20, y-5, 170, 20, 'F');
            doc.setFont("helvetica", "bold");
            doc.text(`DATA RESERVADA: ${dados.dataFormatada}`, 30, y+8);
            doc.text(`VALOR TOTAL: R$ ${dados.valor.toFixed(2)}`, 120, y+8);
            
            y+=30;
            doc.text("TERMOS E REGRAS DO LOCAL:", 20, y);
            y+=10;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const regras = doc.splitTextToSize(dados.regrasTexto || "Sem regras definidas.", 170);
            doc.text(regras, 20, y);

            doc.text("__________________________________________", 105, 240, null, null, "center");
            doc.text("Assinatura Eletrônica do Locatário", 105, 245, null, null, "center");
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Documento gerado digitalmente em ${new Date().toLocaleString()}`, 105, 250, null, null, "center");

            doc.save(`Contrato_Umbelino_${dados.dataISO}.pdf`);
        }
    </script>
</body>
</html>