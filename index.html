<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Lazer - Piscina</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .day-card { aspect-ratio: 1/1; cursor: pointer; transition: all 0.2s; }
        .day-card:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-10">

    <header class="bg-blue-600 text-white p-6 shadow-md text-center">
        <h1 class="text-3xl font-bold"><i class="fa-solid fa-water"></i> Espaço Lazer & Piscina</h1>
        <p class="mt-2 text-blue-100">Selecione uma data disponível para reservar</p>
    </header>

    <main class="max-w-4xl mx-auto mt-8 p-4">
        
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
            <button id="prevMonth" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 id="currentMonthYear" class="text-xl font-bold capitalize text-gray-700"></h2>
            <button id="nextMonth" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="flex gap-4 justify-center mb-4 text-sm">
            <span class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-1"></div> Livre</span>
            <span class="flex items-center"><div class="w-4 h-4 bg-yellow-400 rounded mr-1"></div> Pendente</span>
            <span class="flex items-center"><div class="w-4 h-4 bg-red-500 rounded mr-1"></div> Ocupado/Bloqueado</span>
        </div>

        <div class="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-gray-500">
            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
        </div>

        <div id="calendarGrid" class="calendar-grid"></div>
    </main>

    <script>
        // --- CONFIGURAÇÃO ---
        const SUPABASE_URL = 'SUA_URL_SUPABASE_AQUI';
        const SUPABASE_KEY = 'SUA_CHAVE_ANON_PUBLIC_AQUI';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDate = new Date();
        let configPreco = 0;
        let reservas = [];
        let calendarioCustom = [];

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchConfig();
            await fetchDadosMes();
            renderCalendar();
        });

        document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
        document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

        // --- FUNÇÕES DE DADOS ---
        async function fetchConfig() {
            const { data } = await supabase.from('config').select('preco_padrao').single();
            if(data) configPreco = data.preco_padrao;
        }

        async function fetchDadosMes() {
            // Busca dados para renderizar o mês
            const { data: res } = await supabase.from('reservas').select('*');
            reservas = res || [];
            
            const { data: custom } = await supabase.from('calendario_custom').select('*');
            calendarioCustom = custom || [];
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // --- RENDERIZAÇÃO DO CALENDÁRIO ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('currentMonthYear');
            
            grid.innerHTML = '';
            monthYear.innerText = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding dias vazios
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const el = document.createElement('div');
                el.className = 'day-card flex flex-col items-center justify-center rounded-lg shadow text-sm font-bold relative';
                el.innerText = day;

                // Lógica de Estado
                const reserva = reservas.find(r => r.data === dateStr);
                const custom = calendarioCustom.find(c => c.data === dateStr);
                
                let status = 'livre'; // livre, pendente, ocupado
                let valor = custom?.tipo === 'preco_especial' ? custom.novo_valor : configPreco;

                if (custom?.tipo === 'bloqueio') status = 'ocupado';
                else if (reserva?.status === 'confirmado') status = 'ocupado';
                else if (reserva?.status === 'pendente') status = 'pendente';

                // Estilização baseada no status
                if (status === 'ocupado') {
                    el.classList.add('bg-red-500', 'text-white', 'cursor-not-allowed');
                } else if (status === 'pendente') {
                    el.classList.add('bg-yellow-400', 'text-white', 'cursor-not-allowed');
                    el.innerHTML += `<span class="text-xs font-normal block">Pendente</span>`;
                } else {
                    el.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    el.innerHTML += `<span class="text-xs font-normal block">R$ ${valor}</span>`;
                    el.onclick = () => abrirReserva(dateStr, valor);
                }

                grid.appendChild(el);
            }
        }

        // --- FLUXO DE RESERVA ---
        async function abrirReserva(dataISO, valor) {
            const dataFormatada = new Date(dataISO + 'T00:00:00').toLocaleDateString('pt-BR');

            const { value: formValues } = await Swal.fire({
                title: `Reservar para ${dataFormatada}`,
                html: `
                    <div class="text-left mb-4 text-sm text-gray-600">
                        <p><strong>Valor:</strong> R$ ${valor.toFixed(2)}</p>
                        <p class="mt-2 text-xs">Ao continuar, você concorda com as regras de uso: Proibido som automotivo, horário até 22h, manter limpeza.</p>
                    </div>
                    <input id="swal-nome" class="swal2-input" placeholder="Seu Nome Completo">
                    <input id="swal-cpf" class="swal2-input" placeholder="CPF (000.000.000-00)">
                    <input id="swal-tel" class="swal2-input" placeholder="WhatsApp (11999999999)">
                    <input id="swal-end" class="swal2-input" placeholder="Endereço">
                `,
                focusConfirm: false,
                confirmButtonText: 'Aceitar e Reservar',
                showCancelButton: true,
                preConfirm: () => {
                    const nome = document.getElementById('swal-nome').value;
                    const cpf = document.getElementById('swal-cpf').value;
                    const tel = document.getElementById('swal-tel').value;
                    if (!nome || !cpf || !tel) {
                        Swal.showValidationMessage('Preencha todos os campos obrigatórios');
                    }
                    return { nome, cpf, tel, valor, dataISO, dataFormatada };
                }
            });

            if (formValues) {
                processarReserva(formValues);
            }
        }

        async function processarReserva(dados) {
            Swal.fire({ title: 'Processando...', didOpen: () => Swal.showLoading() });

            // 1. Salvar no Supabase
            const { error } = await supabase.from('reservas').insert({
                data: dados.dataISO,
                status: 'pendente',
                nome: dados.nome,
                cpf: dados.cpf,
                telefone: dados.tel,
                valor_final: dados.valor
            });

            if (error) {
                Swal.fire('Erro', 'Dia já reservado por outra pessoa neste instante.', 'error');
                return;
            }

            // 2. Gerar PDF
            const pdfBlob = gerarPDF(dados);

            // 3. Redirecionar WhatsApp
            const msg = `Olá! Gostaria de confirmar a reserva da piscina para o dia *${dados.dataFormatada}*.%0AValor: R$ ${dados.valor}.%0AMeus dados: ${dados.nome} - CPF: ${dados.cpf}.%0A%0A*O contrato segue em anexo (PDF gerado).*`;
            
            Swal.fire({
                icon: 'success',
                title: 'Pré-reserva realizada!',
                text: 'O contrato foi baixado no seu celular. Envie ele agora no WhatsApp para confirmar.',
                confirmButtonText: 'Ir para WhatsApp'
            }).then(() => {
                window.open(`https://wa.me/55SEUNUMEROAQUI?text=${msg}`, '_blank');
                // Recarrega para atualizar status
                location.reload(); 
            });
        }

        function gerarPDF(dados) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text("CONTRATO DE LOCAÇÃO DE ESPAÇO", 105, 20, null, null, "center");
            
            doc.setFontSize(12);
            doc.text(`LOCATÁRIO: ${dados.nome}, CPF: ${dados.cpf}`, 20, 40);
            doc.text(`DATA DA LOCAÇÃO: ${dados.dataFormatada}`, 20, 50);
            doc.text(`VALOR ACORDADO: R$ ${dados.valor.toFixed(2)}`, 20, 60);
            
            doc.text("TERMOS E REGRAS:", 20, 80);
            doc.setFontSize(10);
            const regras = "1. O locatário se responsabiliza por qualquer dano ao imóvel.\n2. É proibido som automotivo.\n3. Horário de uso: 08:00 às 22:00.\n4. Proibido uso de garrafas de vidro na área da piscina.";
            doc.text(regras, 20, 90);

            doc.text("__________________________________", 105, 150, null, null, "center");
            doc.text("Assinatura Digital (Aceite via Web)", 105, 155, null, null, "center");

            doc.save(`Contrato_${dados.nome}_${dados.dataISO}.pdf`);
        }
    </script>
</body>
</html>